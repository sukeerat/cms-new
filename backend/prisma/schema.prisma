// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// Models

model User {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  email       String?  @unique
  password    String
  name        String
  phoneNo     String?
  rollNumber  String?
  dob         String?
  branchName  String?
  designation String?
  role        Role?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())

  // Password reset fields
  resetPasswordToken  String?
  resetPasswordExpiry DateTime?
  Student             Student?
  ClassAssignment     ClassAssignment[]
  Institution         Institution?            @relation(fields: [institutionId], references: [id])
  institutionId       String?                 @db.ObjectId
  // New internship relations
  Industry            Industry?
  menteeApplications  InternshipApplication[] @relation("StudentMentor")
  mentorAssignments   MentorAssignment[]      @relation("AssignedMentor")
  assignedBy          MentorAssignment[]      @relation("AssignedBy")
  facultyVisitLogs    FacultyVisitLog[]       @relation("FacultyVisits")
  industryRequests    IndustryRequest[]       @relation("RequestSender")
  auditLogs           AuditLog[]              @relation("AuditUser")
  // NEW: Back-relation for industry referrals
  referredIndustries  Industry[]              @relation("IndustryReferredBy")
  referredRequests    IndustryRequest[]       @relation("IndustryRequestReferredBy")
  // New referral relations
  reviewedReferrals   ReferralApplication[]   @relation("ReferralReviewer")
  approvedReferrals   ReferralApplication[]   @relation("ReferralApprover")
  rejectedReferrals   ReferralApplication[]   @relation("ReferralRejector")

  // Notification relations
  notificationSettings NotificationSettings?
  Notification         Notification[]

  // Grievance relations
  supervisedGrievances   Grievance[]              @relation("GrievanceFacultySupervisor")
  assignedGrievances     Grievance[]              @relation("GrievanceAssignedTo")
  grievanceStatusChanges GrievanceStatusHistory[]

  //technical query
  technicalQueries TechnicalQuery[]

  // Help & Support relations
  submittedTickets SupportTicket[]   @relation("TicketSubmitter")
  assignedTickets  SupportTicket[]   @relation("TicketAssignee")
  supportResponses SupportResponse[] @relation("ResponseAuthor")
  faqArticles      FAQArticle[]      @relation("FAQAuthor")

  // consent
  consent   Boolean?  @default(false)
  consentAt DateTime?

  // Login Activity Tracking
  lastLoginAt     DateTime?
  lastLoginIp     String?
  loginCount      Int       @default(0)
  previousLoginAt DateTime?

  // Password Management
  hasChangedDefaultPassword Boolean   @default(false)
  passwordChangedAt         DateTime?

  // Session Management
  sessions UserSession[] @relation("UserSessions")

  // Performance Indexes
  @@index([institutionId])
  @@index([role])
  @@index([institutionId, role])
  @@index([active])
  @@index([lastLoginAt])
  @@index([role, active])
}

enum Role {
  PRINCIPAL
  ACCOUNTANT
  ADMISSION_OFFICER
  EXAMINATION_OFFICER
  TEACHER
  PLACEMENT_OFFICER
  PMS_OFFICER
  EXTRACURRICULAR_HEAD
  STUDENT
  // New roles for internship portal
  INDUSTRY
  INDUSTRY_SUPERVISOR
  STATE_DIRECTORATE
  FACULTY_SUPERVISOR
  SYSTEM_ADMIN
}

// Student Information linked with admissiontype, category, batch, fees, results, documents, and scholarship

model Student {
  id                     String                  @id @default(auto()) @map("_id") @db.ObjectId
  profileImage           String?
  userId                 String                  @unique @db.ObjectId
  user                   User                    @relation(fields: [userId], references: [id])
  rollNumber             String?                 @unique
  branchId               String?                 @db.ObjectId
  branch                 Branch?                 @relation(fields: [branchId], references: [id])
  branchName             String? // Cached for quick access
  admissionNumber        String?                 @unique
  name                   String
  email                  String?
  contact                String?
  address                String?
  pinCode                String?
  tehsil                 String?
  district               String?
  city                   String?
  dob                    String?
  state                  String?
  parentName             String?
  parentContact          String?
  motherName             String?
  gender                 String?
  currentYear            Int?
  currentSemester        Int?
  currentSemesterMarks   Float?
  tenthper               Float?
  twelthper              Float?
  diplomaPercentage      Float?
  totalBacklogs          Int?                    @default(0)
  clearanceStatus        ClearanceStatus         @default(PENDING)
  isActive               Boolean                 @default(true)
  // Preferences
  internshipPreferences  InternshipPreference?
  batchId                String?                 @db.ObjectId
  batch                  Batch?                  @relation(fields: [batchId], references: [id])
  admissionType          AdmissionType?
  category               Category?
  document               Document[]
  fees                   Fee[]
  results                ExamResult[]
  scholarshipId          String?                 @db.ObjectId
  scholarship            Scholarship?            @relation(fields: [scholarshipId], references: [id])
  feeStructureId         String?                 @db.ObjectId
  feeStructure           FeeStructure?           @relation(fields: [feeStructureId], references: [id])
  institutionId          String?                 @db.ObjectId
  Institution            Institution?            @relation(fields: [institutionId], references: [id])
  createdAt              DateTime                @default(now())
  placements             Placement[]
  internshipApplications InternshipApplication[]
  mentorAssignments      MentorAssignment[]
  complianceRecords      ComplianceRecord[]
  monthlyFeedbacks       MonthlyFeedback[]
  monthlyReports         MonthlyReport[]
  grievances             Grievance[]

  // Performance Indexes
  @@index([institutionId])
  @@index([batchId])
  @@index([branchId])
  @@index([institutionId, batchId])
  @@index([institutionId, branchId])
  @@index([clearanceStatus])
  @@index([isActive])
}

model InternshipPreference {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  studentId String  @unique @db.ObjectId
  student   Student @relation(fields: [studentId], references: [id])

  preferredFields        String[] // Array of preferred industry fields
  preferredLocations     String[] // Array of preferred work locations
  preferredDurations     String[] // e.g., ["8 weeks", "12 weeks", "26 weeks"]
  minimumStipend         Float?
  isRemotePreferred      Boolean  @default(false)
  additionalRequirements String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("internship_preferences")
}

enum ClearanceStatus {
  PENDING
  CLEARED
  HOLD
  REJECTED
}

enum AdmissionType {
  FIRST_YEAR
  LEET
}

enum Category {
  GENERAL
  OBC
  ST
  SC
}

// Batch Management (Simplified)
model Batch {
  id               String            @id @default(auto()) @map("_id") @db.ObjectId
  name             String            @unique // e.g., "2023-26"
  isActive         Boolean           @default(true)
  students         Student[]
  classAssignments ClassAssignment[]
  createdAt        DateTime          @default(now())
  Institution      Institution?      @relation(fields: [institutionId], references: [id])
  institutionId    String?           @db.ObjectId

  // Performance Indexes
  @@index([institutionId])
  @@index([isActive])
}

// Document Management (Simplified)
model Document {
  id        String       @id @default(auto()) @map("_id") @db.ObjectId
  studentId String       @db.ObjectId
  type      DocumentType
  fileName  String
  fileUrl   String
  createdAt DateTime     @default(now())
  Student   Student      @relation(fields: [studentId], references: [id])

  // Performance Indexes
  @@index([studentId])
  @@index([type])
}

enum DocumentType {
  MARKSHEET_10TH
  MARKSHEET_12TH
  CASTE_CERTIFICATE
  PHOTO
  OTHER
}

model FeeStructure {
  id                String          @id @default(auto()) @map("_id") @db.ObjectId
  admissionType     AdmissionType // FIRST_YEAR or LEET
  scholarshipScheme ScholarshipType
  semesterNumber    Int // 1-6
  df                Float // Development Fee
  sf                Float // Student Fee
  security          Float // Security Deposit
  tf                Float // Tuition Fee
  total             String // Total Fee
  isActive          Boolean         @default(true)
  createdAt         DateTime        @default(now())
  fees              Fee[]
  students          Student[]
  Institution       Institution?    @relation(fields: [institutionId], references: [id])
  institutionId     String?         @db.ObjectId

  // Unique constraint to prevent duplicates
  @@unique([admissionType, scholarshipScheme, semesterNumber])
  // Performance Indexes
  @@index([institutionId])
  @@index([isActive])
  @@index([institutionId, isActive])
}

// Fee Management (Simplified)

model Fee {
  id             String        @id @default(auto()) @map("_id") @db.ObjectId
  studentId      String        @db.ObjectId
  semesterId     String        @db.ObjectId
  feeStructureId String?       @db.ObjectId
  amountDue      Float
  amountPaid     Float         @default(0)
  dueDate        DateTime
  status         FeeStatus
  createdAt      DateTime      @default(now())
  updatedAt      DateTime?     @updatedAt
  Student        Student       @relation(fields: [studentId], references: [id])
  Semester       Semester      @relation(fields: [semesterId], references: [id])
  FeeStructure   FeeStructure? @relation(fields: [feeStructureId], references: [id])
  Institution    Institution?  @relation(fields: [institutionId], references: [id])
  institutionId  String?       @db.ObjectId

  // Performance Indexes
  @@index([studentId])
  @@index([semesterId])
  @@index([institutionId])
  @@index([status])
  @@index([studentId, semesterId])
  @@index([institutionId, status])
}

enum FeeStatus {
  PAID
  PARTIAL
  PENDING
  WAIVED
}

model Notification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  title     String
  body      String
  type      String?
  data      Json?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  // Performance Indexes
  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@index([userId, read])
}

model NotificationSettings {
  id            String  @id @default(auto()) @map("_id") @db.ObjectId
  userId        String  @unique @db.ObjectId
  assignments   Boolean @default(true)
  attendance    Boolean @default(true)
  examSchedules Boolean @default(true)
  announcements Boolean @default(true)
  grades        Boolean @default(true)
  internships   Boolean @default(true)
  placements    Boolean @default(true)
  feeReminders  Boolean @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_settings")
}

// Authentication (Token Management)

model BlacklistedToken {
  id                 String   @id @default(auto()) @map("_id") @db.ObjectId
  token              String   @unique
  userId             String?  @db.ObjectId
  reason             String?
  isFullInvalidation Boolean  @default(false)
  expiresAt          DateTime
  createdAt          DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

// Scholarship (Simplified)
model Scholarship {
  id            String             @id @default(auto()) @map("_id") @db.ObjectId
  type          ScholarshipType
  amount        Float
  status        ScholarshipStatus?
  createdAt     DateTime           @default(now())
  students      Student[] // 1 scholarship has many students
  Institution   Institution?       @relation(fields: [institutionId], references: [id])
  institutionId String?            @db.ObjectId

  // Performance Indexes
  @@index([institutionId])
  @@index([type])
  @@index([status])
}

enum ScholarshipType {
  CMS50
  CMS60
  CMS70
  CMS80
  CMS90
  PMS
  FWS
}

enum ScholarshipStatus {
  APPROVED
  REJECTED
  DISBURSED
}

// Examination Management (Simplified)

model Semester {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId
  //name     String // e.g., "Semester 1"
  number        Int // e.g., 1, 2, 3, etc.
  results       ExamResult[]
  isActive      Boolean      @default(true)
  fees          Fee[]
  Institution   Institution? @relation(fields: [institutionId], references: [id])
  institutionId String?      @db.ObjectId

  // Performance Indexes
  @@index([institutionId])
  @@index([number])
  @@index([isActive])
}

model Subject {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  syllabusYear   Int
  semesterNumber String?
  branchName     String
  subjectName    String
  subjectCode    String
  maxMarks       Float
  subjectType    String
  createdAt      DateTime     @default(now())
  // ← add back‐relation so you can do subject.examResults
  examResults    ExamResult[]
  Institution    Institution? @relation(fields: [institutionId], references: [id])
  institutionId  String?      @db.ObjectId
  Branch         Branch?      @relation(fields: [branchId], references: [id])
  branchId       String?      @db.ObjectId

  // Performance Indexes
  @@index([institutionId])
  @@index([branchId])
  @@index([subjectCode])
  @@index([institutionId, branchId])
}

model ExamResult {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  studentId  String   @db.ObjectId
  semesterId String   @db.ObjectId
  subjectId  String   @db.ObjectId
  marks      Float
  maxMarks   Float    @default(100)
  createdAt  DateTime @default(now())
  Student    Student  @relation(fields: [studentId], references: [id])
  Semester   Semester @relation(fields: [semesterId], references: [id])
  Subject    Subject  @relation(fields: [subjectId], references: [id])

  // Performance Indexes
  @@index([studentId])
  @@index([semesterId])
  @@index([subjectId])
  @@index([studentId, semesterId])
}

// Placement Management (Simplified)

model Placement {
  id            String          @id @default(auto()) @map("_id") @db.ObjectId
  studentId     String          @db.ObjectId // This is your foreign key
  student       Student         @relation(fields: [studentId], references: [id]) // Add this relation field
  companyName   String
  jobRole       String
  salary        Float?
  offerDate     DateTime
  status        PlacementStatus @default(OFFERED)
  createdAt     DateTime        @default(now())
  Institution   Institution?    @relation(fields: [institutionId], references: [id])
  institutionId String?         @db.ObjectId

  // Performance Indexes
  @@index([studentId])
  @@index([institutionId])
  @@index([status])
  @@index([studentId, status])
  @@index([institutionId, status])
}

enum PlacementStatus {
  OFFERED
  ACCEPTED
  REJECTED
  JOINED
}

// Events Management (Simplified)

// UNUSED - Event management feature not implemented
// model Event {
//     id            String       @id @default(auto()) @map("_id") @db.ObjectId
//     title         String
//     description   String
//     eventType     String
//     startDate     DateTime
//     venue         String
//     isActive      Boolean      @default(true)
//     createdAt     DateTime     @default(now())
//     Institution   Institution? @relation(fields: [institutionId], references: [id])
//     institutionId String?      @db.ObjectId
// }

// UNUSED - Event registration feature not implemented
// model EventRegistration {
//     id             String    @id @default(auto()) @map("_id") @db.ObjectId
//     eventId        String    @db.ObjectId
//     studentId      String    @db.ObjectId
//     attended       Boolean?
//     attendanceDate DateTime?
//     notes          String?
//     createdAt      DateTime  @default(now())
// }

// Teacher Assignment (Simplified)

model ClassAssignment {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId
  teacherId     String       @db.ObjectId
  batchId       String       @db.ObjectId
  section       String?
  academicYear  String?
  isActive      Boolean      @default(true)
  Batch         Batch        @relation(fields: [batchId], references: [id])
  teacher       User         @relation(fields: [teacherId], references: [id])
  Institution   Institution? @relation(fields: [institutionId], references: [id])
  institutionId String?      @db.ObjectId

  // Performance Indexes
  @@index([teacherId])
  @@index([batchId])
  @@index([institutionId])
  @@index([teacherId, isActive])
  @@index([institutionId, isActive])
}

// Institution Model
model Institution {
  id        String          @id @default(auto()) @map("_id") @db.ObjectId
  code      String?         @unique // The unique code for the institution (e.g., "INST001", "MAIN_CAMPUS")
  name      String? // Optional: Full name of the institution
  shortName String?
  type      InstitutionType @default(POLYTECHNIC)

  // Contact Information
  address        String?
  city           String?
  state          String? @default("Punjab")
  district       String?
  pinCode        String?
  country        String? @default("India")
  contactEmail   String?
  contactPhone   String?
  alternatePhone String?
  website        String?

  // Administrative Details
  establishedYear  Int?
  affiliatedTo     String? // University/Board affiliation
  recognizedBy     String? // AICTE, UGC, etc.
  naacGrade        String?
  autonomousStatus Boolean @default(false)

  // Seat Management
  totalStudentSeats Int? // Total allocated seats for students
  totalStaffSeats   Int? // Total allocated seats for staff

  // Configuration
  isActive  Boolean              @default(true)
  settings  InstitutionSettings?
  // Timestamps
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  // --- Relations to other models ---
  // Add relations for models that DIRECTLY belong to an institution
  users            User[]
  batches          Batch[]
  feeStructures    FeeStructure[]
  scholarships     Scholarship[] // Assuming scholarship definitions are per-institution
  semesters        Semester[] // Semesters belong to an institution's academic structure
  subjects         Subject[] // Subjects are defined within an institution/program
  // events           Event[] // UNUSED - Event management feature not implemented
  classAssignments ClassAssignment[] // Assignments happen within an institution
  auditLogs        AuditLog[] // Audit logs should track the institution context
  calendars        Calendar[] // Calendars are institution-specific
  notices          Notice[] // Notices are issued by an institution

  // Note: Models like Student, Fee, Document, ExamResult, Placement, EventRegistration
  // will likely be linked indirectly via their parent (e.g., Student via User or directly,
  // Fee via Student, Document via Student, etc.)
  Student    Student[]
  Fee        Fee[]
  placements Placement[]

  // New internship relations
  industries           Industry[]
  internships          Internship[]
  industryRequests     IndustryRequest[]
  Branch               Branch[]
  Department           Department[]
  referralApplications ReferralApplication[]
  //technical query
  technicalQueries     TechnicalQuery[]

  // Help & Support
  supportTickets SupportTicket[]
}

model InstitutionSettings {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  institutionId String      @unique @db.ObjectId
  institution   Institution @relation(fields: [institutionId], references: [id])

  // Academic Settings
  academicYearStart   String // Format: "YYYY-MM-DD"
  academicYearEnd     String // Format: "YYYY-MM-DD"
  currentAcademicYear String // Format: "2024-25"
  totalSemesters      Int    @default(6)

  // Internship Settings
  minInternshipDuration Int    @default(8) // weeks
  maxInternshipDuration Int    @default(26) // weeks
  mandatoryVisitsCount  Int    @default(4)
  feedbackFrequency     String @default("MONTHLY") // WEEKLY, MONTHLY, QUARTERLY

  // Notification Settings
  emailNotificationsEnabled Boolean @default(true)
  smsNotificationsEnabled   Boolean @default(false)

  // System Settings
  allowSelfRegistration Boolean @default(false)
  maintenanceMode       Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("institution_settings")
}

enum InstitutionType {
  POLYTECHNIC
  ENGINEERING_COLLEGE
  UNIVERSITY
  DEGREE_COLLEGE
  ITI
  SKILL_CENTER
}

// =============================================
// ACADEMIC STRUCTURE
// =============================================

model Branch {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  shortName String
  code      String  @unique
  duration  Int // Duration in years
  isActive  Boolean @default(true)

  institutionId String      @db.ObjectId
  institution   Institution @relation(fields: [institutionId], references: [id])

  students Student[]
  subjects Subject[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("branches")
}

model Department {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  shortName String?
  code      String  @unique
  hodId     String? @db.ObjectId // Head of Department
  isActive  Boolean @default(true)

  institutionId String      @db.ObjectId
  institution   Institution @relation(fields: [institutionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("departments")
}

// Audit Log (Basic)

model AuditLog {
  id         String      @id @default(auto()) @map("_id") @db.ObjectId
  // Core Tracking Information
  entityType String // e.g., "Student", "Internship", "InternshipApplication", "Industry"
  entityId   String?     @db.ObjectId // ID of the affected entity
  action     AuditAction // Standardized actions

  // User Context
  userId   String? @db.ObjectId
  user     User?   @relation("AuditUser", fields: [userId], references: [id])
  userRole Role // Role of the user performing the action
  userName String? // Cache user name for quick reference

  // Change Details
  oldValues     Json? // Previous state of the entity (for updates)
  newValues     Json? // New state of the entity (for creates/updates)
  changedFields String[] // Array of field names that changed

  // Context Information
  description String? // Human-readable description of the action
  category    AuditCategory // Categorize the type of operation
  severity    AuditSeverity @default(LOW) // Importance level

  timestamp     DateTime     @default(now())
  Institution   Institution? @relation(fields: [institutionId], references: [id])
  institutionId String?      @db.ObjectId

  // Performance Indexes
  @@index([userId])
  @@index([entityType, entityId])
  @@index([timestamp])
  @@index([category, timestamp])
  @@index([institutionId])
  @@index([action])
}

// =============================================
// AUDIT ENUMS
// =============================================

enum AuditAction {
  // User Management
  USER_LOGIN
  USER_LOGOUT
  USER_REGISTRATION
  USER_PROFILE_UPDATE
  PASSWORD_CHANGE
  PASSWORD_RESET
  USER_ACTIVATION
  USER_DEACTIVATION

  // Student Operations
  STUDENT_PROFILE_VIEW
  STUDENT_PROFILE_UPDATE
  STUDENT_DOCUMENT_UPLOAD
  STUDENT_DOCUMENT_DELETE

  // Internship Operations
  INTERNSHIP_CREATE
  INTERNSHIP_UPDATE
  INTERNSHIP_DELETE
  INTERNSHIP_ACTIVATE
  INTERNSHIP_DEACTIVATE
  INTERNSHIP_VIEW
  INTERNSHIP_SEARCH

  // Application Operations
  APPLICATION_SUBMIT
  APPLICATION_UPDATE
  APPLICATION_WITHDRAW
  APPLICATION_VIEW
  APPLICATION_APPROVE
  APPLICATION_REJECT
  APPLICATION_BULK_ACTION

  // Industry Operations
  INDUSTRY_REGISTER
  INDUSTRY_PROFILE_UPDATE
  INDUSTRY_APPROVAL
  INDUSTRY_REJECTION
  INDUSTRY_VIEW_APPLICANTS

  // Mentor Assignment
  MENTOR_ASSIGN
  MENTOR_UNASSIGN
  MENTOR_UPDATE

  // Feedback Operations
  MONTHLY_FEEDBACK_SUBMIT
  MONTHLY_FEEDBACK_UPDATE
  COMPLETION_FEEDBACK_SUBMIT
  FEEDBACK_VIEW

  // Faculty Operations
  VISIT_LOG_CREATE
  VISIT_LOG_UPDATE
  VISIT_LOG_DELETE
  VISIT_LOG_VIEW
  FACULTY_ASSIGNMENT

  // Monthly Report Operations
  MONTHLY_REPORT_SUBMIT
  MONTHLY_REPORT_UPDATE
  MONTHLY_REPORT_APPROVE
  MONTHLY_REPORT_REJECT
  MONTHLY_REPORT_DELETE

  // Joining Letter Operations
  JOINING_LETTER_UPLOAD
  JOINING_LETTER_VERIFY
  JOINING_LETTER_REJECT
  JOINING_LETTER_DELETE

  // Administrative Operations
  REPORT_GENERATE
  REPORT_DOWNLOAD
  REPORT_VIEW
  BULK_OPERATION
  DATA_EXPORT
  DATA_IMPORT

  // Institution Operations
  INSTITUTION_CREATE
  INSTITUTION_UPDATE
  INSTITUTION_DELETE

  // System Operations
  SYSTEM_BACKUP
  SYSTEM_RESTORE
  CONFIGURATION_CHANGE
  PERMISSION_CHANGE

  // Security Events
  UNAUTHORIZED_ACCESS
  FAILED_LOGIN
  SUSPICIOUS_ACTIVITY
  DATA_BREACH_ATTEMPT

  // Support Operations
  GRIEVANCE_SUBMIT
  GRIEVANCE_UPDATE
  GRIEVANCE_RESOLVE
  TECHNICAL_QUERY_SUBMIT
  TECHNICAL_QUERY_RESOLVE

  // Compliance Operations
  COMPLIANCE_CHECK
  AUDIT_TRAIL_ACCESS
  PRIVACY_POLICY_UPDATE
  CONSENT_GIVEN
  CONSENT_WITHDRAWN
}

enum AuditCategory {
  AUTHENTICATION // Login, logout, password changes
  PROFILE_MANAGEMENT // Profile updates, document uploads
  INTERNSHIP_WORKFLOW // Internship-related operations
  APPLICATION_PROCESS // Application submissions, approvals
  FEEDBACK_SYSTEM // All feedback operations
  ADMINISTRATIVE // Admin operations, reports
  SECURITY // Security-related events
  COMPLIANCE // Compliance and audit operations
  SYSTEM // System-level operations
  DATA_MANAGEMENT // Data operations, exports, imports
  SUPPORT // Grievances, technical queries
  USER_MANAGEMENT // User creation, updates, deletion
  SYSTEM_ADMIN // System administration operations
}

enum AuditSeverity {
  LOW // Regular operations, views
  MEDIUM // Updates, submissions
  HIGH // Approvals, rejections, assignments
  CRITICAL // Security events, system changes, compliance
}

model Calendar {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId
  title         String
  startDate     DateTime?
  endDate       DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  Institution   Institution? @relation(fields: [institutionId], references: [id])
  institutionId String?      @db.ObjectId

  // Performance Indexes
  @@index([institutionId])
  @@index([startDate])
  @@index([institutionId, startDate])
}

model Notice {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId
  title         String
  message       String
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  Institution   Institution? @relation(fields: [institutionId], references: [id])
  institutionId String?      @db.ObjectId

  // Performance Indexes
  @@index([institutionId])
  @@index([createdAt])
  @@index([institutionId, createdAt])
}

// =============================================
// MENTOR & COMPLIANCE MANAGEMENT
// =============================================

model MentorAssignment {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Relations
  studentId String  @db.ObjectId
  student   Student @relation(fields: [studentId], references: [id])
  mentorId  String  @db.ObjectId
  mentor    User    @relation("AssignedMentor", fields: [mentorId], references: [id])

  // Assignment tracking
  assignedBy       String   @db.ObjectId
  assignedByUser   User     @relation("AssignedBy", fields: [assignedBy], references: [id])
  assignmentDate   DateTime @default(now())
  assignmentReason String?

  // Status
  isActive           Boolean   @default(true)
  deactivatedAt      DateTime?
  deactivatedBy      String?   @db.ObjectId
  deactivationReason String?

  // Context
  academicYear        String
  semester            String?
  specialInstructions String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    String?  @db.ObjectId

  // Note: Uniqueness of active assignment per student is enforced in application code
  // (by deactivating existing assignments before creating new ones)
  // Performance Indexes
  @@index([studentId])
  @@index([mentorId])
  @@index([isActive])
  @@index([mentorId, isActive])
  @@index([studentId, isActive]) // For fast lookup of active assignment
  @@map("mentor_assignments")
}

model ComplianceRecord {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Relations
  studentId String  @db.ObjectId
  student   Student @relation(fields: [studentId], references: [id])

  // Compliance tracking
  complianceType ComplianceType
  status         ComplianceStatus @default(PENDING_REVIEW)

  // Visit compliance
  requiredVisits  Int?      @default(0)
  completedVisits Int?      @default(0)
  lastVisitDate   DateTime?
  nextVisitDue    DateTime?

  // Feedback compliance  
  requiredFeedbacks  Int?      @default(0)
  completedFeedbacks Int?      @default(0)
  lastFeedbackDate   DateTime?
  nextFeedbackDue    DateTime?

  // Overall metrics
  complianceScore Float? // Percentage score
  complianceGrade ComplianceGrade?
  remarks         String?
  actionRequired  String?

  // Review tracking
  reviewedBy     String?   @db.ObjectId
  reviewedAt     DateTime?
  nextReviewDate DateTime?

  // Context
  academicYear String
  semester     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("compliance_records")
}

// =============================================
// INTERNSHIP PORTAL MODELS
// =============================================

// Industry/Company Profile
model Industry {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @unique @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  // Company Information
  companyName        String
  companyDescription String?
  industryType       IndustryType
  establishedYear    Int?
  companySize        CompanySize
  employeeCount      Int?

  // Contact Information
  contactPersonName  String
  contactPersonTitle String
  primaryEmail       String
  alternateEmail     String?
  primaryPhone       String
  alternatePhone     String?
  website            String?

  // Address Information
  address String
  city    String
  state   String
  pinCode String
  country String @default("India")

  // Legal Information
  registrationNumber String
  panNumber          String
  gstNumber          String?

  // Approval Status
  isVerified Boolean   @default(false)
  verifiedAt DateTime?
  verifiedBy String?   @db.ObjectId
  isApproved Boolean   @default(false)
  approvedAt DateTime?
  approvedBy String?   @db.ObjectId

  referralApplications ReferralApplication[] @relation("IndustryReferralApplications")
  approvedReferrals    ApprovedReferral[]    @relation("IndustryApprovedReferrals")

  referredById  String?   @db.ObjectId
  referredBy    User?     @relation("IndustryReferredBy", fields: [referredById], references: [id])
  referralDate  DateTime? // When the referral was made
  referralNotes String? // Optional notes about the referral

  // Relations
  internships         Internship[]
  monthlyFeedbacks    MonthlyFeedback[]
  completionFeedbacks CompletionFeedback[]
  industryRequests    IndustryRequest[]
  grievances          Grievance[]
  // Institution context
  institutionId       String?              @db.ObjectId
  Institution         Institution?         @relation(fields: [institutionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Performance Indexes
  @@index([institutionId])
  @@index([isVerified])
  @@index([isApproved])
  @@index([isVerified, isApproved])
  @@index([referredById])
  @@index([companyName])
  @@index([city, state])
  @@index([institutionId, isApproved])
  @@map("industries")
}

// Core Internship Model
model Internship {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Basic Information
  title               String
  description         String
  detailedDescription String?
  fieldOfWork         String

  // Position Details
  numberOfPositions   Int
  duration            String // e.g., "3 months", "6 months"
  startDate           DateTime?
  endDate             DateTime?
  applicationDeadline DateTime

  // Location Information
  workLocation    String
  isRemoteAllowed Boolean @default(false)

  // Eligibility Criteria
  eligibleBranches  String[] // Can apply to multiple branches
  minimumPercentage Float?
  eligibleSemesters String[] // e.g., ["5", "6"]

  // Stipend Information
  isStipendProvided Boolean @default(false)
  stipendAmount     Float?
  stipendDetails    String?

  // Requirements
  requiredSkills  String[]
  preferredSkills String[]

  //faculty logs required
  totalFacultyVisits Int?             @default(4)
  // Status
  status             InternshipStatus @default(ACTIVE)
  isActive           Boolean          @default(true)

  // Relations
  industryId String   @db.ObjectId
  industry   Industry @relation(fields: [industryId], references: [id])

  applications     InternshipApplication[]
  monthlyFeedbacks MonthlyFeedback[]
  facultyVisitLogs FacultyVisitLog[]
  grievances       Grievance[]

  // Institution context
  institutionId String?      @db.ObjectId
  Institution   Institution? @relation(fields: [institutionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Performance Indexes
  @@index([industryId])
  @@index([institutionId])
  @@index([status])
  @@index([isActive])
  @@index([applicationDeadline])
  @@index([industryId, status])
  @@index([institutionId, status])
  @@index([institutionId, status, isActive])
  @@map("internships")
}

// Student Internship Application
model InternshipApplication {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Relations
  studentId String  @db.ObjectId
  student   Student @relation(fields: [studentId], references: [id])

  internshipId String?     @db.ObjectId
  internship   Internship? @relation(fields: [internshipId], references: [id])

  // Application Details
  applicationDate DateTime @default(now())
  coverLetter     String?
  resume          String?
  additionalInfo  String?

  // Selection Status
  status       ApplicationStatus @default(APPLIED)
  appliedDate  DateTime          @default(now())
  reviewedDate DateTime?

  // Industry Decision
  isSelected      Boolean   @default(false)
  selectionDate   DateTime?
  rejectionReason String?

  // Joining Information
  hasJoined      Boolean   @default(false)
  joiningDate    DateTime?
  completionDate DateTime?

  // Mentor Assignment
  mentorId         String?   @db.ObjectId
  mentor           User?     @relation("StudentMentor", fields: [mentorId], references: [id])
  mentorAssignedAt DateTime?
  mentorAssignedBy String?   @db.ObjectId // Principal/Admin who assigned

  // Self-Identified Internship Fields
  isSelfIdentified Boolean @default(false)
  companyName      String?
  companyAddress   String?
  companyContact   String?
  companyEmail     String?
  hrName           String?
  hrDesignation    String?
  hrContact        String?
  hrEmail          String?
  internshipStatus String? // SELF_IDENTIFIED or OFFERED_BY_COLLEGE

  // Joining Letter
  joiningLetterUrl        String?
  joiningLetterUploadedAt DateTime?

  // Faculty Mentor Details (for self-identified internships)
  facultyMentorName        String?
  facultyMentorContact     String?
  facultyMentorEmail       String?
  facultyMentorDesignation String?

  // Additional Details
  internshipDuration String?
  stipend            String?
  startDate          DateTime?
  endDate            DateTime?
  jobProfile         String?

  // Review Details
  reviewedBy    String?
  reviewedAt    DateTime?
  reviewRemarks String?

  // Notes
  notes String?

  // Relations to feedback
  monthlyFeedbacks   MonthlyFeedback[]
  monthlyReports     MonthlyReport[]
  completionFeedback CompletionFeedback?
  proposedFirstVisit DateTime?
  secondVisit        DateTime?
  facultyVisitLogs   FacultyVisitLog[]

  // Report & Visit Generation Tracking
  reportsGenerated     Boolean @default(false) // True when expected reports have been generated
  totalExpectedReports Int? // Total number of reports expected for this internship
  totalExpectedVisits  Int? // Total number of faculty visits expected

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Performance Indexes
  @@index([studentId])
  @@index([internshipId])
  @@index([status])
  @@index([studentId, status])
  @@index([internshipId, status])
  @@index([mentorId])
  @@index([isSelfIdentified])
  @@index([applicationDate])
  @@index([mentorId, appliedDate])
  @@index([isSelfIdentified, status, applicationDate])
  @@map("internship_applications")
}

// Monthly Feedback from Industry
model MonthlyFeedback {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Relations
  applicationId String                @db.ObjectId
  application   InternshipApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  industryId String?   @db.ObjectId
  industry   Industry? @relation(fields: [industryId], references: [id])

  studentId String?  @db.ObjectId
  student   Student? @relation(fields: [studentId], references: [id])

  internshipId String?     @db.ObjectId
  internship   Internship? @relation(fields: [internshipId], references: [id])

  //student monthly feedback
  imageUrl String?

  // Feedback Details
  feedbackMonth         DateTime // Which month this feedback is for
  attendanceRating      Int? // 1-5 scale
  performanceRating     Int? // 1-5 scale
  punctualityRating     Int? // 1-5 scale
  technicalSkillsRating Int? // 1-5 scale

  // Detailed Feedback
  strengths           String?
  areasForImprovement String?
  tasksAssigned       String?
  tasksCompleted      String?
  overallComments     String?

  // Ratings
  overallRating Int? // 1-5 scale

  // Self-Identified Internship Fields
  reportUrl          String? // Monthly report file URL
  workDescription    String? // Description of work done this month
  skillsLearned      String? // Skills learned during the month
  challenges         String? // Challenges faced
  supervisorFeedback String? // Feedback from company supervisor

  // Submission Details
  submittedAt DateTime @default(now())
  submittedBy String   @db.ObjectId // Industry user who submitted

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Performance Indexes
  @@index([applicationId])
  @@index([studentId])
  @@index([industryId])
  @@index([internshipId])
  @@index([feedbackMonth])
  @@index([applicationId, feedbackMonth])
  @@index([studentId, feedbackMonth])
  @@index([studentId, internshipId, feedbackMonth])
  @@map("monthly_feedbacks")
}

// Student Monthly Report Model
model MonthlyReport {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Relations
  applicationId String                @db.ObjectId
  application   InternshipApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  studentId String  @db.ObjectId
  student   Student @relation(fields: [studentId], references: [id])

  // Report Period
  reportMonth Int // Month number (1-12)
  reportYear  Int
  monthName   String? // e.g., "January", "February" for display

  // Report File
  reportFileUrl String? // PDF/Document file of the report

  // Submission Details
  status      MonthlyReportStatus @default(DRAFT)
  submittedAt DateTime?

  // Review Details (optional - for mentor/faculty review)
  reviewedBy     String?   @db.ObjectId
  reviewedAt     DateTime?
  reviewComments String?

  // Approval
  isApproved Boolean   @default(false)
  approvedBy String?   @db.ObjectId
  approvedAt DateTime?

  // Submission Window (1st-10th of next month)
  dueDate               DateTime? // 10th of next month
  submissionWindowStart DateTime? // 1st of next month
  submissionWindowEnd   DateTime? // 10th of next month
  isOverdue             Boolean   @default(false)

  // Late submission tracking
  isLateSubmission Boolean @default(false)
  daysLate         Int?

  // Report Period Details
  periodStartDate DateTime? // First day of internship month
  periodEndDate   DateTime? // Last day of internship month
  isPartialMonth  Boolean   @default(false) // True for first/last partial months
  isFinalReport   Boolean   @default(false) // True if last report of internship

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([applicationId, reportMonth, reportYear]) // One report per month per application
  // Performance Indexes
  @@index([applicationId])
  @@index([studentId])
  @@index([status])
  @@index([reportMonth, reportYear])
  @@index([dueDate])
  @@map("monthly_reports")
}

// Completion Feedback (from both Student and Industry)
model CompletionFeedback {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Relations
  applicationId String                @unique @db.ObjectId
  application   InternshipApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  // Feedback from Student
  studentFeedback    String?
  studentRating      Int? // 1-5 scale for internship experience
  skillsLearned      String?
  careerImpact       String?
  wouldRecommend     Boolean?
  studentSubmittedAt DateTime?

  // Feedback from Industry
  industryFeedback    String?
  industryRating      Int? // 1-5 scale for student performance
  finalPerformance    String?
  recommendForHire    Boolean?
  industrySubmittedAt DateTime?

  // Overall Assessment
  isCompleted           Boolean @default(false)
  completionCertificate String? // File path if certificate provided

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  Industry   Industry? @relation(fields: [industryId], references: [id])
  industryId String?   @db.ObjectId

  // Performance Indexes
  @@index([industryId])
  @@index([isCompleted])
  @@map("completion_feedbacks")
}

// Faculty Visit Log
model FacultyVisitLog {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Relations
  applicationId String                @db.ObjectId
  application   InternshipApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  // internshipId is optional for self-identified internships
  internshipId String?     @db.ObjectId
  internship   Internship? @relation(fields: [internshipId], references: [id])

  facultyId String? @db.ObjectId
  faculty   User?   @relation("FacultyVisits", fields: [facultyId], references: [id])

  //location of visit
  visitLocation String?

  // GPS Coordinates
  latitude  Float?
  longitude Float?

  // Visit Details
  visitNumber   Int?
  visitDate     DateTime? // Optional for scheduled visits, set when visit is completed
  visitDuration String? // e.g., "2 hours"
  visitType     VisitType      @default(PHYSICAL)
  status        VisitLogStatus @default(SCHEDULED)

  // Observations
  studentPerformance   String?
  workEnvironment      String?
  industrySupport      String?
  skillsDevelopment    String?
  attendanceStatus     String?
  workQuality          String?
  organisationFeedback String?
  projectTopics        String?

  // New fields from the form
  titleOfProjectWork              String? // Title of Project/Work
  assistanceRequiredFromInstitute String? // Assistance Required from the Institute
  responseFromOrganisation        String? // Response from the Organisation
  remarksOfOrganisationSupervisor String? // Remarks of Organisation Supervisor
  significantChangeInPlan         String? // Any significant change with respect to the plan of project/work
  observationsAboutStudent        String? // Observations about the Student (at least 100 words)
  feedbackSharedWithStudent       String? // Feedback shared with the Student (at least 100 words)

  // Ratings (1-5 scale)
  studentProgressRating     Int?
  industryCooperationRating Int?
  workEnvironmentRating     Int?
  mentoringSupportRating    Int?
  overallSatisfactionRating Int?

  // Issues and Recommendations
  issuesIdentified String?
  recommendations  String?
  actionRequired   String?

  filesUrl String? // URLs to any files/photos uploaded

  // Documentation
  visitPhotos    String[] // URLs to photos taken during visit
  meetingMinutes String?
  attendeesList  String[] // Names of people met during visit

  // Administrative
  reportSubmittedTo String?   @db.ObjectId // Principal/Admin
  followUpRequired  Boolean   @default(false)
  nextVisitDate     DateTime?

  // Monthly Visit Tracking
  visitMonth     Int? // Month number (1-12)
  visitYear      Int? // Year of the visit
  requiredByDate DateTime? // Due date for this visit (last day of month or internship end)
  isMonthlyVisit Boolean   @default(true) // True if this is a required monthly visit

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Performance Indexes
  @@index([applicationId])
  @@index([internshipId])
  @@index([facultyId])
  @@index([visitDate])
  @@index([applicationId, visitDate])
  @@index([facultyId, visitDate])
  @@index([visitMonth, visitYear])
  @@map("faculty_visit_logs")
}

// State Directorate Analytics/Reports
model StateReport {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  reportType        ReportType
  reportCategory    StateReportCategory?
  reportPeriod      String // e.g., "Q1 2024", "Annual 2024"
  reportTitle       String?
  reportDescription String?

  // Coverage
  institutionIds    String[] // Institutions covered in report
  fromDate          DateTime?
  toDate            DateTime?
  // Aggregated Data
  totalInternships  Int
  totalApplications Int
  totalPlacements   Int
  institutionCount  Int
  industryCount     Int
  totalStudents     Int?
  totalFaculty      Int?

  // Performance metrics
  applicationToPlacementRatio Float?
  placementRate               Float? // Percentage
  completionRate              Float? // Percentage  
  industryParticipationRate   Float? // Percentage
  averageStipend              Float?
  medianStipend               Float?

  // Analytics
  branchWiseData      Json? // Branch-wise statistics
  institutionWiseData Json? // Institution-wise statistics
  performanceMetrics  Json? // Various KPIs
  industryWiseData    Json? // Industry participation data
  geographicData      Json? // District/city-wise data
  trendData           Json?
  complianceData      Json? // Detailed compliance analysis
  sections            Json? // Report sections with detailed analytics
  selfIdentifiedData  Json? // Self-identified internship data
  // File References
  reportFileUrl       String?
  generatedAt         DateTime @default(now())
  generatedBy         String   @db.ObjectId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("state_reports")
}

// Fee Reports Model
model FeeReport {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  reportType        FeeReportType
  reportPeriod      String // e.g., "Q1 2024", "Annual 2024", "Monthly March 2024"
  reportTitle       String?
  reportDescription String?

  // Coverage
  institutionIds String[] // Institutions covered in report
  branchIds      String[] // Branches covered in report
  semesterIds    String[] // Semesters covered in report
  fromDate       DateTime?
  toDate         DateTime?

  // Aggregated Financial Data
  totalFeesDue       Float
  totalFeesCollected Float
  totalOutstanding   Float
  collectionRate     Float // Percentage
  totalStudents      Int
  totalFeeRecords    Int

  // Breakdown by Status
  paidCount    Int
  partialCount Int
  pendingCount Int
  waivedCount  Int

  // Financial Analytics
  averageFeePerStudent     Float?
  medianFeePerStudent      Float?
  highestFeeCollected      Float?
  lowestFeeCollected       Float?
  scholarshipBeneficiaries Int?
  totalScholarshipAmount   Float?

  // Detailed Analytics
  institutionWiseData   Json? // Institution-wise fee statistics
  branchWiseData        Json? // Branch-wise fee statistics
  semesterWiseData      Json? // Semester-wise fee statistics
  scholarshipWiseData   Json? // Scholarship scheme wise data
  categoryWiseData      Json? // Student category wise data
  admissionTypeWiseData Json? // Admission type wise data
  trendData             Json? // Historical trends
  performanceMetrics    Json? // Various KPIs and performance indicators

  // File References
  reportFileUrl String?
  generatedAt   DateTime @default(now())
  generatedBy   String   @db.ObjectId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("fee_reports")
}

// =============================================
// COMMUNICATION & REQUESTS
// =============================================

model IndustryRequest {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Request details
  requestType     IndustryRequestType
  priority        RequestPriority     @default(MEDIUM)
  title           String
  description     String
  requirements    String?
  expectedOutcome String?

  // Target industry
  industryId String?   @db.ObjectId
  industry   Industry? @relation(fields: [industryId], references: [id])

  // Industry criteria (if no specific industry targeted)
  targetIndustryType   IndustryType?
  preferredLocation    String?
  preferredCompanySize CompanySize?

  // NEW: Referred By fields
  referredById          String?              @db.ObjectId
  referredByType        ReferredByType?
  referredBy            User?                @relation("IndustryRequestReferredBy", fields: [referredById], references: [id])
  referralDate          DateTime?
  referralNotes         String?
  referralApplicationId String?              @db.ObjectId
  referralApplication   ReferralApplication? @relation("RequestReferral", fields: [referralApplicationId], references: [id])

  // Request context
  requestedBy     String      @db.ObjectId
  requestedByUser User        @relation("RequestSender", fields: [requestedBy], references: [id])
  institutionId   String      @db.ObjectId
  institution     Institution @relation(fields: [institutionId], references: [id])

  // Timeline
  requestDeadline    DateTime?
  expectedResponseBy DateTime?

  // Status tracking
  status              RequestStatus @default(SENT)
  statusHistory       Json[] // Track status changes
  responseMessage     String?
  respondedAt         DateTime?
  responseAttachments String[] // URLs to response documents

  // Internal processing
  assignedTo       String? @db.ObjectId // Staff member handling this request
  internalNotes    String?
  followUpRequired Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("industry_requests")
}

// Add the new enum for referral types
enum ReferredByType {
  STATE_DIRECTORATE
  FACULTY_SUPERVISOR
  PRINCIPAL
  PLACEMENT_OFFICER
  SYSTEM_ADMIN
  INDUSTRY_PARTNER
  ALUMNI
  OTHER
}

// New model for referral applications
model ReferralApplication {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Application Details
  title          String
  description    String
  referralType   ReferralType
  targetAudience String[] // e.g., ["STUDENTS", "FACULTY", "INSTITUTIONS"]

  // Applicant Information
  industryId String   @db.ObjectId
  industry   Industry @relation("IndustryReferralApplications", fields: [industryId], references: [id])

  // Application Content
  qualifications    String // Why they qualify for referral
  experienceDetails String // Their experience/track record
  references        Json? // Previous referrals, testimonials
  proposedBenefits  String // What they offer in return

  // Approval Workflow
  status          ReferralApplicationStatus @default(PENDING)
  applicationDate DateTime                  @default(now())

  // Review Process
  reviewedBy     String?   @db.ObjectId
  reviewer       User?     @relation("ReferralReviewer", fields: [reviewedBy], references: [id])
  reviewedAt     DateTime?
  reviewComments String?

  // Approval Details
  approvedBy    String?   @db.ObjectId
  approver      User?     @relation("ReferralApprover", fields: [approvedBy], references: [id])
  approvedAt    DateTime?
  approvalNotes String?

  // Rejection Details
  rejectedBy      String?   @db.ObjectId
  rejector        User?     @relation("ReferralRejector", fields: [rejectedBy], references: [id])
  rejectedAt      DateTime?
  rejectionReason String?

  // Validity Period
  validFrom  DateTime?
  validUntil DateTime?

  // Usage Tracking
  usageCount    Int  @default(0)
  maxUsageLimit Int? // Optional limit on how many times it can be used

  // Institution Context
  institutionId String      @db.ObjectId
  institution   Institution @relation(fields: [institutionId], references: [id])

  // Relations
  industryRequests IndustryRequest[] @relation("RequestReferral")

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  ApprovedReferral ApprovedReferral?

  @@map("referral_applications")
}

// New model for approved referrals that can be used
model ApprovedReferral {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Source Application
  applicationId String              @unique @db.ObjectId
  application   ReferralApplication @relation(fields: [applicationId], references: [id])

  // Referral Details
  referralCode String       @unique // Unique code for this referral
  displayName  String // How it appears in dropdowns
  description  String?
  referralType ReferralType

  // Industry Information
  industryId String   @db.ObjectId
  industry   Industry @relation("IndustryApprovedReferrals", fields: [industryId], references: [id])

  // Usage Controls
  isActive      Boolean @default(true)
  usageCount    Int     @default(0)
  maxUsageLimit Int?

  // Validity
  validFrom  DateTime  @default(now())
  validUntil DateTime?

  // Metadata
  tags     String[] // For filtering/categorization
  category String? // e.g., "Premium", "Standard", "Trial"
  priority Int      @default(0) // For sorting in dropdowns

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("approved_referrals")
}

enum ReferralType {
  INDUSTRY_PARTNERSHIP
  PLACEMENT_ASSISTANCE
  INTERNSHIP_PROVIDER
  GUEST_LECTURER
  MENTOR
  SKILL_TRAINER
  EQUIPMENT_SPONSOR
  SCHOLARSHIP_PROVIDER
  RESEARCH_COLLABORATOR
  CURRICULUM_ADVISOR
  ALUMNI_NETWORK
  STARTUP_INCUBATOR
  OTHER
}

enum ReferralApplicationStatus {
  DRAFT
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  EXPIRED
  SUSPENDED
}

// =============================================
// ENUMS FOR INTERNSHIP PORTAL
// =============================================

enum IndustryType {
  INFORMATION_TECHNOLOGY
  SOFTWARE_DEVELOPMENT
  MANUFACTURING
  AUTOMOTIVE
  ELECTRONICS
  TELECOMMUNICATIONS
  CONSTRUCTION
  CIVIL_ENGINEERING
  MECHANICAL_ENGINEERING
  ELECTRICAL_ENGINEERING
  ENERGY_UTILITIES
  HEALTHCARE
  PHARMACEUTICALS
  FINANCE_BANKING
  EDUCATION
  RESEARCH_DEVELOPMENT
  GOVERNMENT
  STARTUP
  CONSULTING
  MEDIA_ADVERTISING
  RETAIL
  HOSPITALITY
  LOGISTICS_SUPPLY_CHAIN
  AGRICULTURE
  TEXTILES
  CHEMICALS
  AEROSPACE
  DEFENSE
  OTHER
}

enum CompanySize {
  STARTUP // 1-10 employees
  SMALL // 11-50 employees
  MEDIUM // 51-200 employees
  LARGE // 201-1000 employees
  ENTERPRISE // 1000+ employees
}

enum InternshipStatus {
  ACTIVE
  INACTIVE
  COMPLETED
  CANCELLED
}

enum ApplicationStatus {
  APPROVED
  APPLIED
  UNDER_REVIEW
  SHORTLISTED
  SELECTED
  REJECTED
  JOINED
  COMPLETED
  WITHDRAWN
}

enum VisitType {
  PHYSICAL
  VIRTUAL
  TELEPHONIC
}

enum VisitLogStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ReportType {
  MONTHLY
  QUARTERLY
  ANNUAL
  CUSTOM
}

enum FeeReportType {
  MONTHLY
  QUARTERLY
  YEARLY
  SEMESTER_WISE
  INSTITUTION_WISE
  BRANCH_WISE
  SCHOLARSHIP_WISE
  CATEGORY_WISE
  CUSTOM
}

enum IndustryRequestType {
  INTERNSHIP_PARTNERSHIP
  BULK_INTERNSHIP_REQUEST
  GUEST_LECTURE
  INDUSTRY_VISIT
  PLACEMENT_DRIVE
  SKILL_DEVELOPMENT_PROGRAM
  CURRICULUM_COLLABORATION
  RESEARCH_COLLABORATION
  EQUIPMENT_DONATION
  SCHOLARSHIP_SPONSORSHIP
  FACULTY_TRAINING
  STUDENT_MENTORSHIP
  PROJECT_COLLABORATION
  OTHER
}

enum ComplianceType {
  FACULTY_VISIT
  MONTHLY_FEEDBACK
  COMPLETION_FEEDBACK
  DOCUMENTATION
  ATTENDANCE
  OVERALL_INTERNSHIP
}

enum ComplianceStatus {
  COMPLIANT
  NON_COMPLIANT
  PARTIALLY_COMPLIANT
  PENDING_REVIEW
  OVERDUE
  EXEMPTED
}

enum ComplianceGrade {
  EXCELLENT // 90-100%
  GOOD // 75-89%
  AVERAGE // 60-74%
  POOR // 40-59%
  CRITICAL // Below 40%
}

enum RequestStatus {
  DRAFT
  SENT
  DELIVERED
  ACKNOWLEDGED
  UNDER_REVIEW
  IN_PROGRESS
  ACCEPTED
  PARTIALLY_ACCEPTED
  REJECTED
  EXPIRED
  CANCELLED
  COMPLETED
}

enum RequestPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum StateReportCategory {
  EXECUTIVE_SUMMARY
  PERFORMANCE_ANALYTICS
  COMPLIANCE_REPORT
  INDUSTRY_ENGAGEMENT
  STUDENT_PLACEMENT_ANALYSIS
  INSTITUTIONAL_COMPARISON
  TREND_ANALYSIS
  QUALITY_METRICS
  FEEDBACK_ANALYSIS
  GEOGRAPHIC_ANALYSIS
  MONTHLY_SUMMARY
  ANNUAL_REVIEW
}

// Student Grievance Model
model Grievance {
  id                     String            @id @default(auto()) @map("_id") @db.ObjectId
  studentId              String            @db.ObjectId
  student                Student           @relation(fields: [studentId], references: [id])
  title                  String // Changed from 'subject' to match frontend
  category               GrievanceCategory
  description            String
  severity               GrievancePriority @default(MEDIUM) // Changed from 'priority' to match frontend
  status                 GrievanceStatus   @default(PENDING)
  internshipId           String?           @db.ObjectId
  internship             Internship?       @relation(fields: [internshipId], references: [id])
  industryId             String?           @db.ObjectId
  industry               Industry?         @relation(fields: [industryId], references: [id])
  facultySupervisorId    String?           @db.ObjectId
  facultySupervisor      User?             @relation("GrievanceFacultySupervisor", fields: [facultySupervisorId], references: [id])
  assignedToId           String?           @db.ObjectId
  assignedTo             User?             @relation("GrievanceAssignedTo", fields: [assignedToId], references: [id])
  actionRequested        String? // What student wants to happen
  preferredContactMethod String? // EMAIL, PHONE, IN_PERSON
  submittedDate          DateTime          @default(now())
  addressedDate          DateTime?
  resolvedDate           DateTime?
  resolution             String?
  comments               String? // Changed from 'remarks' to match frontend
  attachments            String[]

  // Escalation tracking
  escalationLevel   EscalationLevel @default(MENTOR) // Current escalation level
  escalationHistory Json[]          @default([]) // Array of escalation records
  escalatedById     String?         @db.ObjectId // Last person who escalated
  escalatedAt       DateTime? // Last escalation timestamp
  escalationCount   Int             @default(0) // Number of times escalated
  previousAssignees String[]        @default([]) // Track all previous assignees

  // Status history relation
  statusHistory GrievanceStatusHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Performance Indexes
  @@index([studentId])
  @@index([status])
  @@index([internshipId])
  @@index([assignedToId])
  @@index([studentId, status])
  @@index([escalationLevel])
}

enum GrievanceCategory {
  INTERNSHIP_RELATED
  MENTOR_RELATED
  INDUSTRY_RELATED
  PAYMENT_ISSUE
  WORKPLACE_HARASSMENT
  WORK_CONDITION
  DOCUMENTATION
  WORK_ENVIRONMENT
  SAFETY_CONCERN
  HARASSMENT
  MENTORSHIP
  LEARNING_OPPORTUNITY
  DISCRIMINATION
  WORK_HOURS
  OTHER
}

enum GrievanceStatus {
  SUBMITTED
  PENDING
  UNDER_REVIEW
  IN_PROGRESS
  ADDRESSED
  RESOLVED
  CLOSED
  REJECTED
  ESCALATED
}

enum GrievancePriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// Escalation levels for grievance workflow
enum EscalationLevel {
  MENTOR // Level 1: Assigned mentor/faculty
  PRINCIPAL // Level 2: Institution principal
  STATE_DIRECTORATE // Level 3: State level authority
}

// Track all status changes for grievances
model GrievanceStatusHistory {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  grievanceId String    @db.ObjectId
  grievance   Grievance @relation(fields: [grievanceId], references: [id], onDelete: Cascade)

  fromStatus GrievanceStatus?
  toStatus   GrievanceStatus

  // Who made this change
  changedById String @db.ObjectId
  changedBy   User   @relation(fields: [changedById], references: [id])

  // Escalation tracking
  escalationLevel EscalationLevel?
  escalatedToId   String?          @db.ObjectId

  // Additional context
  remarks String?
  action  String // SUBMITTED, ASSIGNED, ESCALATED, RESPONDED, RESOLVED, CLOSED, etc.

  createdAt DateTime @default(now())

  @@index([grievanceId])
  @@index([changedById])
}

enum MonthlyReportStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  REVISION_REQUIRED
}

// Technical Query: Users can raise technical issues or support tickets
enum TechnicalQueryStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TechnicalQueryPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model TechnicalQuery {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Who raised the query
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  // Core content
  title       String?
  description String?
  attachments String[] @default([]) // file URLs

  // Status & priority
  status   TechnicalQueryStatus   @default(OPEN)
  priority TechnicalQueryPriority @default(MEDIUM)

  // Conversation / resolution
  resolution String?

  // Context
  institutionId String?      @db.ObjectId
  Institution   Institution? @relation(fields: [institutionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("technical_queries")
}

// =============================================
// HELP & SUPPORT SYSTEM
// =============================================

enum SupportCategory {
  TECHNICAL_ISSUES
  ACCOUNT_PROFILE
  FEATURE_GUIDANCE
  DATA_REPORTS
  INTERNSHIP_QUERIES
  GENERAL_INQUIRIES
}

enum SupportTicketStatus {
  OPEN
  ASSIGNED
  IN_PROGRESS
  PENDING_USER
  RESOLVED
  CLOSED
}

enum SupportTicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// Support Ticket - Main ticket model for help requests
model SupportTicket {
  id           String @id @default(auto()) @map("_id") @db.ObjectId
  ticketNumber String @unique // Format: SUP-YYYYMMDD-XXXX

  // Submitter information
  submittedById  String  @db.ObjectId
  submittedBy    User    @relation("TicketSubmitter", fields: [submittedById], references: [id])
  submitterRole  Role
  submitterName  String // Cached for quick reference
  submitterEmail String?

  // Ticket content
  subject     String
  description String
  category    SupportCategory
  priority    SupportTicketPriority @default(MEDIUM)
  attachments String[]              @default([])

  // Status tracking
  status        SupportTicketStatus @default(OPEN)
  statusHistory Json[]              @default([]) // Track status changes

  // Assignment
  assignedToId String?   @db.ObjectId
  assignedTo   User?     @relation("TicketAssignee", fields: [assignedToId], references: [id])
  assignedAt   DateTime?
  assignedBy   String?   @db.ObjectId

  // Resolution
  resolution     String?
  resolvedAt     DateTime?
  resolvedById   String?   @db.ObjectId
  closedAt       DateTime?
  closedById     String?   @db.ObjectId
  closureRemarks String?

  // Responses/Thread
  responses SupportResponse[]

  // Context
  institutionId String?      @db.ObjectId
  institution   Institution? @relation(fields: [institutionId], references: [id])

  // Metadata
  lastResponseAt   DateTime?
  lastResponseById String?   @db.ObjectId
  responseCount    Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Performance Indexes
  @@index([submittedById])
  @@index([assignedToId])
  @@index([status])
  @@index([category])
  @@index([priority])
  @@index([institutionId])
  @@index([status, priority])
  @@index([submittedById, status])
  @@index([createdAt])
  @@map("support_tickets")
}

// Support Response - Conversation thread for tickets
model SupportResponse {
  id       String        @id @default(auto()) @map("_id") @db.ObjectId
  ticketId String        @db.ObjectId
  ticket   SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  // Responder info
  responderId   String @db.ObjectId
  responder     User   @relation("ResponseAuthor", fields: [responderId], references: [id])
  responderRole Role
  responderName String // Cached for quick reference

  // Response content
  message     String
  attachments String[] @default([])

  // Metadata
  isInternal Boolean @default(false) // Internal notes not visible to submitter

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ticketId])
  @@index([responderId])
  @@index([createdAt])
  @@map("support_responses")
}

// FAQ Article - Knowledge base articles
model FAQArticle {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Content
  title    String
  content  String // Markdown/HTML content
  summary  String? // Brief summary for search results
  category SupportCategory
  tags     String[]        @default([])

  // Role-based visibility - which roles can see this FAQ
  // Empty array means visible to ALL roles (public)
  targetRoles String[] @default([])

  // Publishing
  isPublished Boolean   @default(false)
  publishedAt DateTime?
  publishedBy String?   @db.ObjectId

  // Author
  authorId   String @db.ObjectId
  author     User   @relation("FAQAuthor", fields: [authorId], references: [id])
  authorName String // Cached for display

  // Analytics
  viewCount    Int @default(0)
  helpfulCount Int @default(0)

  // SEO & Search
  slug        String   @unique // URL-friendly slug
  searchTerms String[] @default([]) // Additional search keywords

  // Ordering
  sortOrder Int @default(0) // For manual ordering within category

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([isPublished])
  @@index([viewCount])
  @@index([category, isPublished])
  @@map("faq_articles")
}

// =============================================
// BULK JOB TRACKING SYSTEM
// =============================================

// Track all bulk operations for history and reporting
model BulkJob {
  id        String        @id @default(auto()) @map("_id") @db.ObjectId

  // Job identification
  jobId     String        @unique // BullMQ job ID
  type      BulkJobType
  status    BulkJobStatus @default(QUEUED)

  // File information
  fileName      String
  fileSize      Int
  originalName  String?

  // Progress tracking
  totalRows     Int       @default(0)
  processedRows Int       @default(0)
  successCount  Int       @default(0)
  failedCount   Int       @default(0)
  progress      Int       @default(0) // 0-100 percentage

  // Results (stored as JSON for flexibility)
  errorReport   Json?     // Array of failed rows with reasons
  successReport Json?     // Array of created records summary
  warnings      Json?     // Array of warnings

  // Timing
  queuedAt      DateTime  @default(now())
  startedAt     DateTime?
  completedAt   DateTime?
  processingTime Int?     // In milliseconds

  // Error handling
  errorMessage  String?   // Overall error message if job failed
  retryCount    Int       @default(0)
  maxRetries    Int       @default(3)

  // Context
  institutionId String    @db.ObjectId
  createdById   String    @db.ObjectId

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Performance Indexes
  @@index([institutionId])
  @@index([createdById])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([institutionId, status])
  @@index([institutionId, type])
  @@index([createdById, status])
  @@map("bulk_jobs")
}

enum BulkJobType {
  STUDENTS
  USERS
  INSTITUTIONS
  SELF_INTERNSHIPS
}

enum BulkJobStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// =============================================
// REPORT BUILDER SYSTEM
// =============================================

// Saved Report Templates - Users can save report configurations for reuse
model ReportTemplate {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  reportType  String // e.g., "mentor-student-assignments", "student-directory"
  description String?

  // Configuration stored as JSON
  columns   Json // Selected columns array
  filters   Json // Applied filters object
  groupBy   String?
  sortBy    String?
  sortOrder String? // "asc" | "desc"

  // Metadata
  createdBy     String  @db.ObjectId
  institutionId String? @db.ObjectId
  isPublic      Boolean @default(false) // Share with other users

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("report_templates")
}

// Generated Reports - Track generated reports and their outputs
model GeneratedReport {
  id            String  @id @default(auto()) @map("_id") @db.ObjectId
  reportType    String
  reportName    String? // Human-readable name
  configuration Json // Full config used to generate

  // Output
  fileUrl String? // Path to generated file
  format  String // "pdf" | "excel" | "csv" | "json"

  // Statistics
  totalRecords Int?
  generatedAt  DateTime @default(now())

  // Metadata
  generatedBy   String   @db.ObjectId
  institutionId String?  @db.ObjectId
  expiresAt     DateTime // Auto-cleanup old reports

  status       String  @default("pending") // pending, processing, completed, failed
  errorMessage String?

  createdAt DateTime @default(now())

  @@index([generatedBy])
  @@index([expiresAt])
  @@index([status])
  @@map("generated_reports")
}

// =============================================
// TOKEN BLACKLIST & SESSION MANAGEMENT
// =============================================

model TokenBlacklist {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  tokenHash String   @unique // SHA-256 hash of the token
  expiresAt DateTime // When the token expires
  createdAt DateTime @default(now())

  @@index([expiresAt])
  @@map("token_blacklist")
}

model UserSession {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  user   User   @relation("UserSessions", fields: [userId], references: [id], onDelete: Cascade)

  // Session tracking
  ipAddress  String?
  userAgent  String?
  deviceInfo String?

  // Session lifecycle
  createdAt      DateTime  @default(now())
  lastActivityAt DateTime  @default(now())
  expiresAt      DateTime
  invalidatedAt  DateTime? // When session was explicitly invalidated

  // Session metadata
  refreshTokenHash String? // Hash of refresh token for this session

  @@index([userId])
  @@index([invalidatedAt])
  @@index([expiresAt])
  @@map("user_sessions")
}

// =============================================
// SYSTEM ADMIN - BACKUP & CONFIGURATION
// =============================================

model BackupRecord {
  id               String       @id @default(auto()) @map("_id") @db.ObjectId
  filename         String
  description      String?
  size             Int          // Size in bytes
  storageLocations String[]     // ['minio', 'local']
  minioKey         String?      // Key in MinIO bucket
  localPath        String?      // Path on local filesystem
  status           BackupStatus @default(COMPLETED)

  // Creator tracking
  createdById      String       @db.ObjectId
  createdAt        DateTime     @default(now())

  // Restore tracking
  restoredAt       DateTime?
  restoredById     String?      @db.ObjectId

  @@index([createdAt])
  @@index([status])
  @@map("backup_records")
}

enum BackupStatus {
  IN_PROGRESS
  COMPLETED
  FAILED
  RESTORED
}

model BackupSchedule {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  name           String
  cronExpression String    // Cron expression for schedule timing
  storageType    String    // 'minio', 'local', 'both'
  retentionDays  Int       @default(30)
  isActive       Boolean   @default(true)
  lastRun        DateTime?
  createdById    String    @db.ObjectId
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([isActive])
  @@map("backup_schedules")
}

model SystemConfig {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  key       String   @unique
  value     Json
  category  String   // 'general', 'security', 'features', 'notifications', 'maintenance'
  updatedBy String?  @db.ObjectId
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  @@index([category])
  @@map("system_configs")
}
